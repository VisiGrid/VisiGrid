name: Update Winget

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to submit (without v prefix)'
        required: true

jobs:
  update-winget:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Install wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Wait for release asset
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/VisiGrid/VisiGrid/releases/download/v$version/VisiGrid-windows-x64.zip"
          $maxAttempts = 30
          $delay = 20

          for ($i = 1; $i -le $maxAttempts; $i++) {
            try {
              # GitHub redirects release downloads to CDN â€” must follow redirects
              $response = Invoke-WebRequest -Uri $url -Method Head -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "Asset available at attempt $i"
                break
              }
            } catch {
              if ($i -eq $maxAttempts) {
                Write-Error "Asset not available after $maxAttempts attempts: $url"
                exit 1
              }
              Write-Host "Attempt $i/$maxAttempts - asset not yet available, waiting ${delay}s..."
              Start-Sleep -Seconds $delay
            }
          }

      - name: Submit to winget-pkgs
        shell: pwsh
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/VisiGrid/VisiGrid/releases/download/v$version/VisiGrid-windows-x64.zip"

          .\wingetcreate.exe update VisiGrid.VisiGrid `
            --version $version `
            --urls $url `
            --submit `
            --token $env:WINGET_GITHUB_TOKEN
