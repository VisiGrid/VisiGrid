name: Update Winget

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to submit (without v prefix)'
        required: true

jobs:
  update-winget:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - name: Get version
        id: version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          fi

      - name: Install wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe

      - name: Submit to winget-pkgs
        shell: pwsh
        env:
          WINGET_GITHUB_TOKEN: ${{ secrets.WINGET_GITHUB_TOKEN }}
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $url = "https://github.com/VisiGrid/VisiGrid/releases/latest/download/VisiGrid-windows-x64.zip"

          .\wingetcreate.exe update VisiGrid.VisiGrid `
            --version $version `
            --urls $url `
            --submit `
            --token $env:WINGET_GITHUB_TOKEN
