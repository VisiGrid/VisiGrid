app-id: app.visigrid.VisiGrid
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: visigrid
separate-locales: false

finish-args:
  # GPU access (Vulkan via Blade)
  - --device=dri
  # Display protocols
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # File access for opening/saving spreadsheets
  # (gpui does not yet support XDG portal file pickers)
  - --filesystem=home
  # Network (for VisiHub sync â€” remove if not needed)
  - --share=network

modules:
  - name: visigrid
    buildsystem: simple
    build-commands:
      - install -Dm755 visigrid ${FLATPAK_DEST}/bin/visigrid
      - install -Dm755 visigrid-cli ${FLATPAK_DEST}/bin/visigrid-cli

      # Desktop file (rename to match Flatpak ID)
      - install -Dm644 visigrid.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key="Exec" --set-value="visigrid %F" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-key="Icon" --set-value="${FLATPAK_ID}" ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      # Icons
      - install -Dm644 visigrid.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 icon-512.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - install -Dm644 icon-256.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm644 icon-128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 icon-64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png
      - install -Dm644 icon-32.png ${FLATPAK_DEST}/share/icons/hicolor/32x32/apps/${FLATPAK_ID}.png
      - install -Dm644 icon-16.png ${FLATPAK_DEST}/share/icons/hicolor/16x16/apps/${FLATPAK_ID}.png

      # Metainfo (upstream, kept in source repo)
      - install -Dm644 app.visigrid.VisiGrid.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml

      # License
      - install -Dm644 LICENSE ${FLATPAK_DEST}/share/licenses/${FLATPAK_ID}/LICENSE

    sources:
      # Linux x86_64 binary from GitHub Releases
      - type: archive
        url: https://github.com/VisiGrid/VisiGrid/releases/download/v0.5.9/VisiGrid-linux-x86_64.tar.gz
        sha256: 0000000000000000000000000000000000000000000000000000000000000000
        strip-components: 1
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/VisiGrid/VisiGrid/releases/latest
          version-query: .tag_name
          url-query: '.assets[] | select(.name=="VisiGrid-linux-x86_64.tar.gz") | .browser_download_url'
          is-main-source: true

      # Linux aarch64 binary from GitHub Releases
      - type: archive
        url: https://github.com/VisiGrid/VisiGrid/releases/download/v0.5.9/VisiGrid-linux-aarch64.tar.gz
        sha256: 0000000000000000000000000000000000000000000000000000000000000000
        strip-components: 1
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://api.github.com/repos/VisiGrid/VisiGrid/releases/latest
          version-query: .tag_name
          url-query: '.assets[] | select(.name=="VisiGrid-linux-aarch64.tar.gz") | .browser_download_url'

      # SVG icon (not in tarball)
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/assets/visigrid.svg
        sha256: be9e0d3fd1196fc4626f22c8f566a3c82e28add663bcdc79f2186c200eeab852
        dest-filename: visigrid.svg

      # Icons (not in tarball)
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-512.png
        sha256: 8be3cc00f9ff06ecb4181289a79af9d5b7465b00e782a8c160744fe2a4846cb8
        dest-filename: icon-512.png
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-256.png
        sha256: 91665cb0add21790deb08f1da22b520f1302b666ca480df9915e81d86ec75b60
        dest-filename: icon-256.png
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-128.png
        sha256: f655d1b60c3891c5305da433aa81f8034c011882132719a7158241de6223b5b2
        dest-filename: icon-128.png
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-64.png
        sha256: 4c29d9ac2a954f3b8f92beac1987326299511433f039ee4794f5767b6b66face
        dest-filename: icon-64.png
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-32.png
        sha256: 7814c24b730b73ccf318299556a8d96fa242f9f5c7ca3ce975fe97b83e971470
        dest-filename: icon-32.png
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/gpui-app/assets/icon-16.png
        sha256: d43a763f770d2325cf6f6a4fb9e4cddbf063d27bc6bf01342a8138b3289ea24f
        dest-filename: icon-16.png

      # Metainfo (upstream source of truth)
      - type: file
        path: app.visigrid.VisiGrid.metainfo.xml

      # License
      - type: file
        url: https://raw.githubusercontent.com/VisiGrid/VisiGrid/v0.5.9/LICENSE
        sha256: 96d4ac99caf3914e8c0f9586097def70fa8223a35efa5ae3e306fc5ee2ee2778
        dest-filename: LICENSE
