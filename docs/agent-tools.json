{
  "$schema": "https://raw.githubusercontent.com/anthropics/anthropic-cookbook/main/misc/mcp_tool_schema.json",
  "name": "visigrid",
  "version": "1.0.0",
  "description": "Deterministic spreadsheet engine. Verifiable builds, reconciliation, and formula evaluation. All tools output JSON for reliable parsing.",
  "tools": [
    {
      "name": "visigrid_calc",
      "description": "Evaluate a spreadsheet formula against CSV data. Returns the computed value or a structured error. Use for SUM, AVERAGE, VLOOKUP, SUMIF, and 90+ other functions.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "formula": {
            "type": "string",
            "description": "Spreadsheet formula starting with '='. Examples: '=SUM(A:A)', '=VLOOKUP(\"key\",A:B,2,FALSE)', '=SUMIF(B:B,\">1000\",C:C)'"
          },
          "data": {
            "type": "string",
            "description": "CSV data to evaluate against"
          },
          "headers": {
            "type": "boolean",
            "description": "Whether first row contains headers (excluded from column references)",
            "default": false
          }
        },
        "required": ["formula", "data"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "value": { "type": ["string", "number", "boolean", "null"] },
          "error": { "type": "string" }
        }
      },
      "examples": [
        {
          "input": { "formula": "=SUM(A:A)", "data": "amount\\n100\\n200\\n300", "headers": true },
          "output": { "value": 600 }
        }
      ],
      "invocation": "echo '$DATA' | visigrid-cli calc '$FORMULA' --from csv --headers"
    },
    {
      "name": "visigrid_diff",
      "description": "Reconcile two CSV datasets by key column. Reports matches, missing rows, and value differences. Handles financial formats ($1,234.56) and numeric tolerance.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "left": {
            "type": "string",
            "description": "CSV data for left side"
          },
          "right": {
            "type": "string",
            "description": "CSV data for right side"
          },
          "key": {
            "type": "string",
            "description": "Key column name or letter (e.g., 'id', 'A')"
          },
          "tolerance": {
            "type": "number",
            "description": "Numeric tolerance for value comparisons (absolute)",
            "default": 0
          }
        },
        "required": ["left", "right", "key"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "summary": {
            "type": "object",
            "properties": {
              "matched": { "type": "integer" },
              "only_left": { "type": "integer" },
              "only_right": { "type": "integer" },
              "diff": { "type": "integer" },
              "diff_outside_tolerance": { "type": "integer" }
            }
          },
          "results": { "type": "array" }
        }
      },
      "invocation": "visigrid-cli diff left.csv right.csv --key '$KEY' --tolerance $TOL --out json"
    },
    {
      "name": "visigrid_sheet_apply",
      "description": "Build a .sheet file from a Lua script. Replacement semantics: the Lua script is the source of truth, the output is a build artifact. Returns fingerprint for verification.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "output_path": {
            "type": "string",
            "description": "Path for output .sheet file"
          },
          "lua_script": {
            "type": "string",
            "description": "Lua build script content. Use set(cell, value), clear(cell), meta(target, table), style(target, table)."
          },
          "verify": {
            "type": "string",
            "description": "Expected fingerprint. If provided and mismatch, command fails with exit 1."
          },
          "dry_run": {
            "type": "boolean",
            "description": "Compute fingerprint without writing file",
            "default": false
          }
        },
        "required": ["output_path", "lua_script"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" },
          "fingerprint": { "type": "string" },
          "semantic_ops": { "type": "integer" },
          "style_ops": { "type": "integer" },
          "cells_changed": { "type": "integer" },
          "dry_run": { "type": "boolean" },
          "output": { "type": ["string", "null"] }
        }
      },
      "invocation": "visigrid-cli sheet apply '$OUTPUT' --lua script.lua --json"
    },
    {
      "name": "visigrid_sheet_inspect",
      "description": "Inspect cells, ranges, or workbook metadata from a .sheet file. Use to verify build results before declaring success.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "file": {
            "type": "string",
            "description": "Path to .sheet file"
          },
          "target": {
            "type": "string",
            "description": "Cell (A1), range (A1:D10), or omit for workbook metadata"
          },
          "include_style": {
            "type": "boolean",
            "description": "Include formatting information",
            "default": false
          }
        },
        "required": ["file"]
      },
      "outputSchema": {
        "oneOf": [
          {
            "type": "object",
            "description": "Workbook metadata",
            "properties": {
              "fingerprint": { "type": "string" },
              "sheet_count": { "type": "integer" },
              "cell_count": { "type": "integer" }
            }
          },
          {
            "type": "object",
            "description": "Single cell",
            "properties": {
              "cell": { "type": "string" },
              "value": { "type": "string" },
              "formula": { "type": ["string", "null"] },
              "value_type": { "type": "string" }
            }
          },
          {
            "type": "object",
            "description": "Range",
            "properties": {
              "range": { "type": "string" },
              "cells": { "type": "array" }
            }
          }
        ]
      },
      "invocation": "visigrid-cli sheet inspect '$FILE' $TARGET --json"
    },
    {
      "name": "visigrid_sheet_fingerprint",
      "description": "Compute the fingerprint of a .sheet file. Use to capture state before/after modifications.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "file": {
            "type": "string",
            "description": "Path to .sheet file"
          }
        },
        "required": ["file"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "file": { "type": "string" },
          "fingerprint": { "type": "string" },
          "ops": { "type": "integer" }
        }
      },
      "invocation": "visigrid-cli sheet fingerprint '$FILE' --json"
    },
    {
      "name": "visigrid_sheet_verify",
      "description": "Verify a .sheet file matches an expected fingerprint. Exit 0 = match, exit 1 = mismatch. Use as final validation step.",
      "inputSchema": {
        "type": "object",
        "properties": {
          "file": {
            "type": "string",
            "description": "Path to .sheet file"
          },
          "fingerprint": {
            "type": "string",
            "description": "Expected fingerprint (format: v1:N:hash)"
          }
        },
        "required": ["file", "fingerprint"]
      },
      "outputSchema": {
        "type": "object",
        "properties": {
          "verified": { "type": "boolean" },
          "expected": { "type": "string" },
          "computed": { "type": "string" }
        }
      },
      "invocation": "visigrid-cli sheet verify '$FILE' --fingerprint '$FP'"
    }
  ],
  "lua_api": {
    "description": "Functions available in Lua build scripts for visigrid_sheet_apply",
    "functions": [
      {
        "name": "set",
        "signature": "set(cell, value)",
        "description": "Set cell value or formula. Affects fingerprint.",
        "examples": ["set(\"A1\", \"Revenue\")", "set(\"B2\", 10000)", "set(\"C3\", \"=SUM(B:B)\")"]
      },
      {
        "name": "clear",
        "signature": "clear(cell)",
        "description": "Clear cell value. Affects fingerprint.",
        "examples": ["clear(\"A1\")"]
      },
      {
        "name": "meta",
        "signature": "meta(target, table)",
        "description": "Set semantic metadata. Affects fingerprint. Use for tagging inputs, headers, etc.",
        "examples": ["meta(\"A1\", { role = \"header\" })", "meta(\"B2:B10\", { type = \"input\" })"]
      },
      {
        "name": "style",
        "signature": "style(target, table)",
        "description": "Set presentation style. Does NOT affect fingerprint. Use for formatting.",
        "examples": ["style(\"A1\", { bold = true })", "style(\"A1:D1\", { bold = true, italic = true })"]
      }
    ],
    "fingerprint_boundary": {
      "included": ["set", "clear", "meta"],
      "excluded": ["style"],
      "rationale": "Agents can format sheets without breaking verification. Style is presentation, not semantics."
    }
  }
}
